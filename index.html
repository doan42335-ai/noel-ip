<!DOCTYPE html>
<html>
<head>
    <title>Christmas AR Hand Tracking</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4/hands.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3/camera_utils.min.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        /* ·∫®n ph·∫ßn t·ª≠ video ƒë·ªÉ camera ch·ªâ ho·∫°t ƒë·ªông ·ªü ch·∫ø ƒë·ªô n·ªÅn */
        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            visibility: hidden; 
        }
        /* Hi·ªÉn th·ªã tr·∫°ng th√°i ·ªü cu·ªëi m√†n h√¨nh (gi·ªëng nh∆∞ trong ·∫£nh c·ªßa b·∫°n) */
        #status {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #00ff66; /* M√†u xanh l√° n·ªïi b·∫≠t */
            font-size: 18px;
            font-family: sans-serif;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            z-index: 100;
        }
    </style>
</head>
<body>

    <video id="video"></video>
    <div id="status">ƒê∆∞a tay v√†o camera</div>

<script>
// ===================================
// KH·ªûI T·∫†O C√ÅC BI·∫æN C∆† B·∫¢N C·ª¶A THREE.JS
// ===================================
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.z = 30;
camera.position.y = 10;
camera.lookAt(0, 0, 0);

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setClearColor(0x000000);
document.body.appendChild(renderer.domElement);

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

// ===================================
// KH·ªûI T·∫†O C√ÇY TH√îNG T·ª™ H·∫†T (PARTICLES)
// ===================================
const COUNT = 3000;
const geo = new THREE.BufferGeometry();
const pos = new Float32Array(COUNT * 3);
const target = new Float32Array(COUNT * 3);
const colors = new Float32Array(COUNT * 3);
let mode = 'IDLE'; // 'IDLE', 'TREE', 'EXPLODE'

for(let i = 0; i < COUNT; i++) {
    // V·ªã tr√≠ ban ƒë·∫ßu (random trong kh√¥ng gian)
    pos[i*3] = (Math.random() - 0.5) * 40;
    pos[i*3+1] = (Math.random() - 0.5) * 40;
    pos[i*3+2] = (Math.random() - 0.5) * 40;

    // V·ªã tr√≠ m·ª•c ti√™u (d·∫°ng n√≥n c√¢y th√¥ng)
    const t = i / COUNT; // 0 ƒë·∫øn 1
    const r = (1 - t) * 15; // B√°n k√≠nh l·ªõn ·ªü g·ªëc (15), nh·ªè ·ªü ƒë·ªânh
    const a = Math.random() * Math.PI * 2; // G√≥c ng·∫´u nhi√™n
    
    target[i*3] = Math.cos(a) * r;
    target[i*3+1] = 22 - 44 * t; // Chi·ªÅu cao t·ª´ 22 (ƒë·ªânh) ƒë·∫øn -22 (g·ªëc)
    target[i*3+2] = Math.sin(a) * r;

    // ƒë√®n nhi·ªÅu m√†u
    const c = [
        [1, 0, 0], [0, 1, 0], [0, 0.8, 1], [1, 0.8, 0]
    ][Math.floor(Math.random() * 4)];
    colors[i*3] = c[0]; 
    colors[i*3+1] = c[1]; 
    colors[i*3+2] = c[2];
}

geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
geo.setAttribute('color', new THREE.BufferAttribute(colors, 3));

const mat = new THREE.PointsMaterial({ size: 0.65, vertexColors: true });
const points = new THREE.Points(geo, mat);
scene.add(points);

// ===== STAR TOP (Ng√¥i sao tr√™n ƒë·ªânh) =====
const star = new THREE.Mesh(
    new THREE.IcosahedronGeometry(2.3, 0),
    new THREE.MeshBasicMaterial({ color: 0xffffcc })
);
star.position.y = 23;
scene.add(star);

// ===== TEXT (Banner Ch√∫c M·ª´ng) =====
const loader = new THREE.TextureLoader();
// **Ch√∫ √Ω:** ƒê·∫£m b·∫£o link ·∫£nh n√†y c√≤n ho·∫°t ƒë·ªông. N·∫øu kh√¥ng, b·∫°n c·∫ßn thay b·∫±ng ·∫£nh kh√°c.
const textSprite = new THREE.Sprite(
    new THREE.SpriteMaterial({ map: loader.load('https://i.imgur.com/0Z8YV6H.png'), transparent: true })
);
textSprite.scale.set(22, 8, 1);
textSprite.position.y = -26;
scene.add(textSprite);

// ===================================
// HAND AI (S·ª¨ D·ª§NG MEDIAPIPE)
// ===================================
const video = document.getElementById('video');
const statusDiv = document.getElementById('status'); // ƒê·ªïi t√™n bi·∫øn ƒë·ªÉ tr√°nh tr√πng l·∫∑p

const hands = new Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
hands.setOptions({ maxNumHands: 1, minDetectionConfidence: .6, minTrackingConfidence: .6 });
hands.onResults(r => {
    if (!r.multiHandLandmarks) {
        mode = 'IDLE';
        statusDiv.textContent = 'üéÑ ƒê∆∞a tay v√†o camera';
        return;
    }
    
    const lm = r.multiHandLandmarks[0];
    const wrist = lm[0]; // C·ªï tay
    const tip = lm[8];   // ƒê·∫ßu ng√≥n tr·ªè
    
    // T√≠nh kho·∫£ng c√°ch gi·ªØa ng√≥n tr·ªè v√† c·ªï tay (ƒë·ªÉ x√°c ƒë·ªãnh c·ª≠ ch·ªâ n·∫Øm/x√≤e)
    const d = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);

    if (d < 0.18) { // Kho·∫£ng c√°ch nh·ªè (c·ª≠ ch·ªâ n·∫Øm tay)
        mode = 'TREE';
        statusDiv.textContent = 'üéÑ C√¢y th√¥ng Noel';
    } else if (d > 0.34) { // Kho·∫£ng c√°ch l·ªõn (c·ª≠ ch·ªâ x√≤e tay)
        mode = 'EXPLODE';
        statusDiv.textContent = 'üéÜ Ph√°o hoa';
    } else {
        mode = 'IDLE';
        statusDiv.textContent = 'üëã N·∫Øm ho·∫∑c x√≤e tay';
    }
});

// Kh·ªüi ƒë·ªông Camera. **facingMode:'user'** s·ª≠ d·ª•ng camera tr∆∞·ªõc (selfie).
// N·∫øu b·∫°n mu·ªën d√πng camera sau, ƒë·ªïi th√†nh 'environment'.
new Camera(video, {
    onFrame: async () => await hands.send({ image: video }),
    width: 640,
    height: 480,
    facingMode: 'user'
}).start();

// ===================================
// ANIMATE (H√†m ho·∫°t ·∫£nh)
// ===================================
function animate() {
    requestAnimationFrame(animate);
    const p = geo.attributes.position.array;
    
    for(let i = 0; i < COUNT; i++){
        let i3 = i * 3;
        
        if(mode === 'TREE'){
            // Di chuy·ªÉn t·ª´ t·ª´ ƒë·∫øn v·ªã tr√≠ c√¢y th√¥ng (target)
            p[i3] += (target[i3] - p[i3]) * .055;
            p[i3+1] += (target[i3+1] - p[i3+1]) * .055;
            p[i3+2] += (target[i3+2] - p[i3+2]) * .055;
        } else if(mode === 'EXPLODE'){
            // Di chuy·ªÉn ng·∫´u nhi√™n (ph√°o hoa)
            p[i3] += (Math.random() - .5) * 1.6;
            p[i3+1] += (Math.random() - .5) * 1.6;
            p[i3+2] += (Math.random() - .5) * 1.6;
        }
    }
    
    geo.attributes.position.needsUpdate = true;
    star.rotation.y += .06;
    
    // T·∫°o hi·ªáu ·ª©ng nh·∫•p nh√°y cho ch·ªØ
    textSprite.material.opacity = 0.7 + Math.sin(Date.now() * 0.004) * 0.3;
    
    renderer.render(scene, camera);
}
animate();
</script>

</body>
</html>
